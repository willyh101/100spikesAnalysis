%%
% Attempts to recreate the plots using a cell-by-cell analysis, where the
% final average occurs across all cells, as opposed to across ensembles
%
% Unclear how to index into All.out.anal.minDistbyHolo (see line ~96 below)
%
% Also unclear how to baseline All.out.exp.dfData (currently using the
% first six seconds average across relevant trials for the cell; line ~88)
%%
clear; close all; clc;

%%
% Adds all subfolders to the path
restoredefaultpath;
folder = fileparts(which('cellByCellAnalysis_GH.m')); 
addpath(genpath(folder));
rmpath(folder);

%% Loop over each experiment

% loadPath = '/Users/gregoryhandy/Research_Local/outputdata1/'; % where ever your files are
loadPath = '/Users/greghandy/Research_Local_v2/'; % where ever your files are
% loadList_all = oriLoadList_GH('all');
loadList_all = oriLoadList_GH('used');

ensNum = 1;
expNum = 1;
cellData = [];
%%
for outer_loop = 1:length(loadList_all)
    
    %% Load the data from a specific experiment (code from Will)
    loadList = loadList_all(outer_loop);
    [All,opts,outVars] = loadData_GH(loadList,loadPath);
       
    %% Get orientation tuning and OSI from dataset
    [All, outVars] = getTuningCurve(All, opts, outVars);
    [All, outVars] = calcOSI(All, outVars);
    [All, outVars] = calcTuningCircular(All, outVars); % note: only works on tuned cells (ie. not for max of visID=1)
    [All, outVars] = getEnsembleOSI(All, outVars); % for ensembles specifically
    [All, outVars] = defineDistanceTypes(All, outVars);
    All.out.exp.ensMaxD =  outVars.ensMaxD;
    
    
    %% Only consider valid ensembles from this experiment
    ensIDs = outVars.ensHNumber(outVars.ensemblesToUse);
    cellsToUse = [];
    tempTrial = 0;
    %% Loop over all ensembles and store the data
    for ii = 1:length(ensIDs)
        
        ensID = ensIDs(ii);
        s = ensID;
        us = unique(All.out.exp.stimID);
        u = us(s);
        
        % Trials to use
        trialsToUse = ismember(All.out.exp.stimID, u) &...
            All.out.exp.lowMotionTrials &...
            All.out.exp.lowRunTrials &...
            All.out.exp.stimSuccessTrial &... %All.out.exp.visID == 1;
           (All.out.exp.visID == 1 |  All.out.exp.visID == 0 ); % not sure what this is   
        %ismember(All.out.exp.visID, [0 1]);
                
        tempTrial = tempTrial + sum(trialsToUse);
        %% Cells to use
        holo = All.out.exp.stimParams.roi{s};  % tracks stimID -> hologram
        
%         tg = All.out.exp.rois{holo}; % these are cells in ensemble
        % fixed finding the cells in the ensembles? 
        % Not used for this analysis
        tg_adj = All.out.exp.holoTargets{holo}(~isnan(All.out.exp.holoTargets{holo}));
        
        offTargetRisks = All.out.anal.offTargetRisk(holo,:);
        ROIinArtifact  = All.out.anal.ROIinArtifact; % cells at edge of FOV in laser artifact
        pVis = All.out.anal.pVisR;
%         visCells = All.out.anal.pVisR < 0.05; % visually responsive
%         cellsToUse = ~offTargetRisks & ~ROIinArtifact' & visCells;
        cellsToUse = ~ROIinArtifact' & ~All.out.anal.cellsToExclude;
%         cellsToUse = true(1,length(pVis));
                    
        
        tgCell = zeros(length(cellsToUse),1);
        tgCell(tg_adj) = true;
        numOfTgs(ensNum) = length(tg_adj);
        if length(tg_adj)<7
            'here';
        end
        %% Baseline the df data
        % Options: dfData, zdfData, allData
        
        % Method 1: 
        recWinSec=opts.recWinRange+All.out.exp.visStart;
        winToUse = round(recWinSec*All.out.info.FR);
        bwinToUse = max(floor([0 All.out.exp.visStart]*All.out.info.FR),[1 1]);
        tracesHolodfData = All.out.exp.dfData(cellsToUse, :, trialsToUse);
        dfCellResp = mean((mean(tracesHolodfData(:,winToUse(1):winToUse(end),:),2)),3);
        baselineEst = mean((mean(tracesHolodfData(:,bwinToUse(1):bwinToUse(2),:),2)),3);
        dffCellResp2 = (dfCellResp-baselineEst);
         
        % Method 2: use results from anal 
        tempResp = squeeze(All.out.anal.respMat(s,cellsToUse));
        tempBase = squeeze(All.out.anal.baseMat(s,cellsToUse));
        dffCellResp = (tempResp-tempBase)';
        
        % Methods should be identical, but something is off...
%         if norm(dffCellResp-dffCellResp2)~=0
%            plot(dffCellResp,dffCellResp2)
%            'here';
%         end
        
        
        %% Unclear how to index into All.out.anal.minDistbyHolo
        
        % All.out.exp.ensMaxD has 20 entires but All.out.anal.minDistbyHolo
        % has 21 entries
        % All.out.anal.minDistbyHolo(1,:) is all 0's so using holo seems
        % wrong. So instead, use ensID (or s) from above
        cellDist = All.out.anal.minDistbyHolo(ensID,cellsToUse)';
        cellPO = All.out.anal.prefOri(cellsToUse)';
        cellOSI = All.out.anal.osi(cellsToUse)';
        
        %% Shared across all cells 
        cellEnsMaxD = All.out.exp.ensMaxD(holo)*ones(sum(cellsToUse),1);
        cellMeanEnsOSI = All.out.exp.meanEnsOSI(holo)*ones(sum(cellsToUse),1);
        cellEnsOSI = All.out.exp.ensOSI(holo)*ones(sum(cellsToUse),1);
        cellEnsPO = All.out.exp.ensPO(holo)*ones(sum(cellsToUse),1);
        %%
        
        tempIndices = find(dffCellResp>2 & cellDist<20 & ~offTargetRisks(cellsToUse)');
        if ~isempty(tempIndices) && 0
            tempIndices %(664)
            %%
%             tempIndices = tg_adj();
            tracesHolodfData = All.out.exp.dfData(cellsToUse, :, trialsToUse);
            
            recWinSec=opts.recWinRange+All.out.exp.visStart;
            winToUse = round(recWinSec*All.out.info.FR);
            bwinToUse = max(floor([0 All.out.exp.visStart]*All.out.info.FR),[1 1]);
            baselineEst = squeeze(mean(tracesHolodfData(tempIndices(1),bwinToUse(1):bwinToUse(2),:)));
            
            figure(131432499); clf; 
            subplot(2,length(tg_adj),1); hold on;
            baselinedResp = zeros(12,24);
            for gg = 1:size(tracesHolodfData,3)
                baselinedResp(gg,:) = tracesHolodfData(tempIndices(1),:,gg)-baselineEst(gg);
                plot(baselinedResp(gg,:),'color',[0 0 0 0.3])
            end
            
            plot(mean(baselinedResp),'k','linewidth',2)
            plot(round(All.out.exp.visStart*All.out.info.FR)+[0 0],[-1 7],'k--')
            plot(round((All.out.exp.visStart+1)*All.out.info.FR)+[0 0],[-1 7],'k--')
          
            tempResp = mean(baselinedResp);
            mean(tempResp(winToUse(1):winToUse(2)))
            dffCellResp(tempIndices(1))
            ylim([-1 5])
            title(sprintf('Dist to Stim: %.2f',cellDist(tempIndices(1))))

            %%
        end
        %%
        if expNum>15 &&  0
            figure(131432499); clf; 
        tracesHolodfData = All.out.exp.dfData(:, :, trialsToUse);
        recWinSec=opts.recWinRange+All.out.exp.visStart;
        winToUse = round(recWinSec*All.out.info.FR);
        bwinToUse = max(floor([0 All.out.exp.visStart]*All.out.info.FR),[1 1]);
        figure(131432499); hold on;
        baselinedResp=[];
        for stimLoop = 1:length(tg_adj)
            
            baselineEst = squeeze(mean(tracesHolodfData(tg_adj(stimLoop),bwinToUse(1):bwinToUse(2),:)));
            subplot(2,length(tg_adj),stimLoop+length(tg_adj)); hold on;
            for gg = 1:size(tracesHolodfData,3)
                baselinedResp(gg,:) = tracesHolodfData(tg_adj(stimLoop),:,gg)-baselineEst(gg);
                plot(baselinedResp(gg,:),'color',[0 0 0 0.3])
            end
            plot(mean(baselinedResp),'k','linewidth',2)
            plot(round(All.out.exp.visStart*All.out.info.FR)+[0 0],[-1 5],'k--')
            plot(round((All.out.exp.visStart+1)*All.out.info.FR)+[0 0],[-1 5],'k--')
            title(sprintf('Dist to Stim: %.2f',All.out.anal.minDistbyHolo(ensID,tg_adj(stimLoop))))
        end
        end
        
        %%
        
        
        cellData = [cellData; dffCellResp...
            cellDist cellPO cellOSI cellEnsMaxD cellMeanEnsOSI cellEnsOSI pVis(cellsToUse)' offTargetRisks(cellsToUse)'...
            tgCell(cellsToUse) ensNum*ones(sum(cellsToUse),1) expNum*ones(sum(cellsToUse),1) cellEnsPO];
        ensNum = ensNum + 1;
    end
    
    if ~isempty(cellsToUse)
        expNum = expNum +1;
    end
    
    fprintf('Exp %d out of %d done loading\n',outer_loop, length(loadList_all));
end

%%

cellTable = array2table(cellData,'VariableNames',{'dff','cellDist','cellPO','cellOSI','cellEnsMaxD',...
    'cellMeanEnsOSI','cellEnsOSI','visP','offTarget','tgCell','ensNum','expNum','ensPO'});


%%
oriVals = [NaN 0:45:315];
cellOris = oriVals(cellTable.cellPO)';
cellOrisDiff = abs(cellOris-cellTable.ensPO);
cellOrisDiff(cellOrisDiff>180) = abs(cellOrisDiff(cellOrisDiff>180)-360);
cellOrisDiff(cellOrisDiff==135)=45;
cellOrisDiff(cellOrisDiff==180)=0;
cellTable.cellOrisDiff = cellOrisDiff;

%% Target cell statistics
tgRespAve = []; tgRespErr=[]; numTg = [];
for ii = 1:cellTable.ensNum(end)
    tgSelector = cellTable.ensNum == ii & cellTable.tgCell == 1;
    
    numTg(ii) = sum(tgSelector);
    tgRespAve(ii) = nanmean(cellTable.dff(tgSelector));
    tgRespErr(ii) = nanstd(cellTable.dff(tgSelector))/sqrt(sum(tgSelector));
    
    
    numTgAct(ii) = sum(cellTable.dff(tgSelector)>0.5);
    
end
    
tgSelectorAll = cellTable.tgCell == 1;
tgRespAll = cellTable.dff(tgSelectorAll);
%%

figure(22); clf;
subplot(3,2,1)
boxplot(tgRespAll)
ylabel('\DeltaF/F')
set(gca,'fontsize',16)

subplot(3,2,2)
histogram(tgRespAll)
xlabel('\DeltaF/F')
set(gca,'fontsize',16)

subplot(3,1,2); hold on;
hTemp = histogram(numTg);
hTemp2 = histogram(numTgAct);
plot(mean(numTg),max(hTemp.Values),'*','markersize',16,'color',[0 0.447 0.741])
plot(mean(numTgAct),max(hTemp2.Values),'*','markersize',16,'color',[0.85 0.325 0.098])
% plot(numTgAct,'.-')
xlabel('# Matched Targets')
set(gca,'fontsize',16)
legend('All Tgs','dF/F>0.5 Tgs')

subplot(3,1,3)
errorbar(tgRespAve,tgRespErr)
set(gca,'fontsize',16)
ylabel('Ens Mean \DeltaF/F')
xlabel('Ens Number')

%%
cellRespAll=[];
suppFrac = zeros(cellTable.ensNum(end),1);
actFrac = zeros(cellTable.ensNum(end),1);
for ii = 1:cellTable.ensNum(end)
    cellSelectorAll = cellTable.offTarget==0 & cellTable.ensNum == ii;
    cellRespTemp = cellTable.dff(cellSelectorAll);
    suppFrac(ii) = sum(cellRespTemp<0)/sum(cellSelectorAll);
    actFrac(ii) = sum(cellRespTemp>0)/sum(cellSelectorAll);
end
figure(11);clf; 
subplot(1,2,1); hold on;
histogram(suppFrac*100,[20:5:70])
plot(mean(suppFrac*100),[50],'*','markersize',15)
plot(50+[0 0],[0 50],'k--','linewidth',1.5)
set(gca,'fontsize',16)
xlabel('% of Population Suppressed')

subplot(1,2,2); hold on;
boxplot(suppFrac*100)
set(gca,'fontsize',16)
ylabel('% of Population Suppressed')
xticklabels('')
% subplot(1,3,3); hold on;
% plot(mean(suppFrac*100),'k.','markersize',15)
% errorbar(mean(suppFrac*100),std(suppFrac*100)/sqrt(cellTable.ensNum(end)),'k','linewidth',1.5)
% ylim([50 60])
set(gca,'fontsize',16)
ylabel('% of Population Suppressed')
xticklabels('')
clc;
fprintf('Percent of cells suppressed: %.2f%% %s %.2f%%\n',mean(suppFrac)*100,char(177),std(suppFrac)/sqrt(cellTable.ensNum(end))*100) 
fprintf('Percent of cells activated: %.2f%% %s %.2f%%\n',mean(actFrac)*100,char(177),std(actFrac)/sqrt(cellTable.ensNum(end))*100) 
%%
cellRespAll=[];
thresVal = 0.05;
suppFrac = zeros(cellTable.ensNum(end),1);
actFrac = zeros(cellTable.ensNum(end),1);
for ii = 1:cellTable.ensNum(end)
    cellSelectorAll = cellTable.offTarget==0 & cellTable.ensNum == ii;
    cellRespTemp = cellTable.dff(cellSelectorAll);
    suppFrac(ii) = sum(cellRespTemp<-thresVal)/sum(cellSelectorAll);
    actFrac(ii) = sum(cellRespTemp>thresVal)/sum(cellSelectorAll);
end
figure(999); clf; 
subplot(1,2,1); hold on;
histogram((suppFrac-actFrac)*100)
plot(mean((suppFrac-actFrac)*100),[50],'*','markersize',15)
plot(0+[0 0],[0 50],'k--','linewidth',1.5)
set(gca,'fontsize',16)
xlabel('Suppressed % - Activated %')
title(sprintf('Threshold: %.2f',thresVal))

subplot(1,2,2); hold on;
boxplot((suppFrac-actFrac)*100)
set(gca,'fontsize',16)
ylabel('Suppressed % - Activated %')
xticklabels('')

fprintf('Thres: %0.2f \n',thresVal)
fprintf('Percent of cells suppressed: %.2f%% %s %.2f%%\n',mean(suppFrac)*100,char(177),std(suppFrac)/sqrt(cellTable.ensNum(end))*100) 
fprintf('Percent of cells activated: %.2f%% %s %.2f%%\n',mean(actFrac)*100,char(177),std(actFrac)/sqrt(cellTable.ensNum(end))*100) 

%%


ensResp = FigSpace(cellTable);


figure(3423134); clf; hold on;
plot(tgRespAve,ensResp,'.','markersize',16)
plot([0 5], 0+[0 0],'k--','linewidth',1.5) 
set(gca,'fontsize',16)

fitLM2 = fit(tgRespAve',ensResp,'poly1');
plot(tgRespAve',fitLM2.p2+fitLM2.p1*tgRespAve','linewidth',2)
xlabel('Mean Ens \Delta F/F')
ylabel('Mean evoked \Delta F/F')

%% Plot the data


Fig3_cbc(cellTable,1)

%%
tic;
% cellCond = cellTable.offTarget==0 & cellTable.visP<0.05 & cellTable.cellOSI > 0.25;
cellCond = cellTable.offTarget==0;
Fig3(cellTable,cellCond)
toc;

%%

distBins = [15:15:250];
plotDist = distBins(1:end-1) + 15/2;
cellAct=[];
cellSupp = [];
for ll = 1:length(distBins)-1
    cellSelectorDist = cellTable.cellDist>distBins(ll) & cellTable.cellDist<distBins(ll+1);
    
    cellSelectorCond = cellTable.offTarget==0 & cellTable.visP<0.05 & cellTable.cellOSI > 0.25;
    
    cellSelector = cellSelectorDist & cellSelectorCond;
    
    cellAct(ll) = sum(cellTable.dff(cellSelector)>0)/sum(cellSelector);
    cellSupp(ll) = sum(cellTable.dff(cellSelector)<-0)/sum(cellSelector);
end

figure(); clf; hold on;
plot(plotDist,cellAct*100,'linewidth',1.5)
plot(plotDist,cellSupp*100,'linewidth',1.5)
plot(plotDist,50+0*plotDist,'k--','linewidth',1.5)
set(gca,'fontsize',16)
legend('Activated','Suppressed')
xlabel('Min Dist to Stim Location')
%%
cellCond = cellTable.offTarget==0 & cellTable.visP<0.05 & cellTable.cellOSI > 0.25;
tic;
Fig5(cellTable,cellCond);
toc;

%%
[cellResponsesIso, cellResponsesOrtho]=Fig5_cbc(cellTable,cellCond);

%%

figure(23434210); clf;
subplot(1,2,1); hold on;
boxplot([cellResponsesIso; cellResponsesOrtho], ...
    [ones(length(cellResponsesIso),1); 2*ones(length(cellResponsesOrtho),1)])
set(gca,'fontsize',16)
title('First bin distributions')
ylabel('\DeltaF/F')
extickslables({'Iso','Ortho'})

subplot(1,2,2); hold on
bar([sum(cellResponsesIso>0)/length(cellResponsesIso) ...
    sum(cellResponsesOrtho>0)/length(cellResponsesOrtho)])
plot([0 3], 0.5 + [0 0],'k--')
set(gca,'fontsize',16)




%% Tight co-tuned investigation

Fig6(cellTable,0)
Fig6IsoOrtho(cellTable,cellOrisDiff)

%%
[cellResponsesTight, cellResponsesLoose] = Fig6_cbc(cellTable,0);
%%

figure(12312423); clf;
subplot(1,2,1);
boxplot([cellResponsesTight{1}; cellResponsesLoose{1}; cellResponsesTight{2}; cellResponsesLoose{2}],...
    [ones(length(cellResponsesTight{1}),1); 2*ones(length(cellResponsesLoose{1}),1); ...
    3*ones(length(cellResponsesTight{2}),1); 4*ones(length(cellResponsesLoose{2}),1)])
set(gca,'fontsize',16)

subplot(1,2,2); hold on;
bar([sum(cellResponsesTight{1}>0)/length(cellResponsesTight{1}),...
    sum(cellResponsesLoose{1}>0)/length(cellResponsesLoose{1}),...
    sum(cellResponsesTight{2}>0)/length(cellResponsesTight{2}),...
    sum(cellResponsesLoose{2}>0)/length(cellResponsesLoose{2})])
plot([0 5],0.5+0*[0 5],'k--','linewidth',1.5)
set(gca,'fontsize',16)

